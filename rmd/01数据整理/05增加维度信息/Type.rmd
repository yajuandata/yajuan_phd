---
title: "Type"
output: html_document
date: "2023-09-06"
---
摘要：增加数据的维度信息

加载包
```{r} 
library(tidyverse)
library(readxl)
library(writexl)
library(furrr)
library(data.table)
```

定义方法
```{r, echo=FALSE, message=FALSE}
# 定义方法，将数据文件与维度信息文件匹配
type <- function(data, out, base, target) {
  # 读取baseline维度信息文件，将列名bseline改为pic,将列名"Baseline type"改为type。
  base_info <- read_xlsx(base) %>%
    rename(pic = baseline) %>%
    rename(type = `baseline_type`) %>%
    select(-block)

  # 读取target维度信息文件，2至5列变形成1列，列名为pic,将列名"weidu"改为type。
  target_info <- read_xlsx(target) %>%
    pivot_longer(cols = c(2:5), names_to = "ta", values_to = "pic") %>%
    rename(type = weidu) %>%
    select(-block, -ta)

  # 合并baseline和target维度信息文件
  info <- base_info %>%
    full_join(target_info)

  # 读取数据文件
  dt <- fread(data)

  # 匹配数据文件与info
  dt2 <- dt %>%
    left_join(info, by = "pic")

  # 判断dt2中是否有名为stime的数据列，有的话对数据根据stime进行升序排序，没有的话对数据根据time进行升序排序
  if ("stime" %in% colnames(dt2)) {
    dt2 <- dt2 %>% arrange(stime)
  } else {
    dt2 <- dt2 %>% arrange(time)
  }

  # 用fwrite保存匹配后的数据文件
  fwrite(dt2, out, na = "NA")

  gc()
}

# 接收一个目录和两个参数（baseinfo, targetinfo），生成输入文件路径列表，建立一个新目录，新目录名为输入目录名加_type，将输入文件路径列表和新目录名作为参数，调用type方法。
type_dir <- function(dir, baseinfo, targetinfo) {
  # 生成输入文件路径列表
  files <- list.files(dir, full.names = TRUE)
  # 建立一个新目录，新目录名为输入目录名加_type
  new_dir <- paste0(dir, "_type")
  dir.create(new_dir)
  # 合并新目录与输入文件名列表，形成输出文件路径列表
  out <- paste0(new_dir, "/", basename(files))
  # 调用type方法
  future_map2(files, out, ~ type(data = .x, out = .y, base = baseinfo, target = targetinfo))
}
```

批量处理
```{r, echo=FALSE, message=FALSE}
# 定义输入目录，baseline维度信息文件，target维度信息文件
dir1 <- "../yajuan_data/out/fix2_AOI"
dir2 <- "../yajuan_data/out/blinks2"
dir3 <- "../yajuan_data/out/sacc2_AOI"
dir4 <- "../yajuan_data/out/raw2_AOI"
dir5 <- "../yajuan_data/out/sacc2_AOI"

# 形成目录列表
dirs <- c(dir5)

baseinfo <- "info/baseline_type.xlsx"
targetinfo <- "info/target_type.xlsx"

# 调用type_dir方法,批量处理，设置进程数为5
plan(multisession, workers = 5)
future_map(dirs, ~ type_dir(dir = .x, baseinfo = baseinfo, targetinfo = targetinfo))
```
